<!doctype html>
<html>
<head>
	<meta charset="UTF-8"/>
	<title>RAXY</title>
	
	<!-- jquery-->
	<script src="js/jquery.js" type="text/javascript"></script>
	
	<!-- fabric.js -->
	<script src="js/fabric.js-1.6.0-rc.1/dist/fabric.js" type="text/javascript"></script>
		
	<!-- bootstrap -->	
	<link rel="stylesheet" href="css/bootstrap.min.css" type="text/css"/>
	<link rel="stylesheet" href="css/bootstrap-treeview.min.css" type="text/css"/>
	<link rel="stylesheet" href="css/combobox/select2-bootstrap.min.css" type="text/css"/>
	<script src="js/bootstrap.min.js" type="text/javascript"></script>
	<script src="js/bootstrap-treeview.min.js" type="text/javascript"></script>
	<script src="js/combobox/select2.full.min.js" type="text/javascript"></script>
	
	<!-- my scripts and stylesheets -->	
	<link rel="stylesheet" href="ConstructorStyles.css" type="text/css"/>	
	<script src="js/helper.js" type="text/javascript"></script>
	<script src="js/properties.js" type="text/javascript"></script>
	<script src="js/templates.js" type="text/javascript"></script>
	
</head>
	<body>		
		<div class="btn-group" style="width: 100%;">
			<div class="btn-group">
				<button class="btn btn-default dropdown-toggle" type="button" data-toggle="dropdown">
					File
					<span class="caret"></span>
				</button>
				<ul class="dropdown-menu">
					<li><a href="#" onclick="fCanvas.forEachObject(function(obj){ fCanvas.remove(obj); }); showObjects();">New</a></li>
					<li><a href="#" onclick="doExport();">Export</a></li>
					<li><a href="#">Import Fake</a></li>
				</ul>
			</div>
			<div class="btn-group">
				<button class="btn btn-default dropdown-toggle" type="button" data-toggle="dropdown">
					Edit
					<span class="caret"></span>
				</button>
				<ul class="dropdown-menu">
					<li><a href="#">Undo Fake</a></li>
					<li><a href="#">Redo Fake</a></li>
				</ul>
			</div>
			<div class="btn-group">
				<button class="btn btn-default dropdown-toggle" type="button" data-toggle="dropdown">
					Help
					<span class="caret"></span>
				</button>
				<ul class="dropdown-menu">
					<li><a href="#">User Guide Fake</a></li>
					<li><a href="#">About Fake</a></li>
				</ul>
			</div>
		</div>
		<div class="container-fluid">
			<div class="row row-fullHeight">
				<div id="objectsList" class="col-sm-2">
					<div id="treeview-selectable" class="treeview">

					</div>
				</div>
				<div id="canvasDiv" class="col-sm-8">
					<canvas id="canvas"></canvas>
				</div>			
				<div id="toolbox" class="col-sm-2">
					<div  id="toolboxTabs" class = "btn-group">
						<button class="btn btn-default" onclick="showObjects();">Objects</button>
						<button class="btn btn-default" onclick="showProperties(fCanvas.getActiveObject());">Properties</button>
					</div>
					<div id="toolboxContent" class="panel-group">
						<div class="panel panel-default">
							<a class="btn btn-default" data-toggle="collapse" data-parent="#toolboxContent" href="#roadGroup" style="width:100%">
								Road
							</a>
							<div id="roadGroup" class="panel-collapse collapse">
								<div class="panel-body">
									<div class="btn-group-vertical" style="width: 100%;">
										<button type="button" class="btn btn-default" id="singleRoad" onclick="CreateGraphicObject('singleRoad');" onmouseup="dropElement('singleRoad')">
											<img src="Images/road.png" alt="Road">
											Дорога
										</button>
									</div>
								</div>
							</div>
						</div>
						<div class="panel panel-default">
							<a class="btn btn-default" data-toggle="collapse" data-parent="#toolboxContent" href="#markGroup" style="width:100%">
								Mark Up
							</a>
							<div id="markGroup" class="panel-collapse collapse">
								<div class="panel-body">
									<div class="btn-group-vertical" style="width: 100%;">
										<button type="button" class="btn btn-default" id="single_dotted_markup" onclick="CreateGraphicObject('single_dotted_markup');">
											<img src="Images/markup.png" alt="markup" style="padding-right: 5px;">
											Single Dotted
										</button>
										<button type="button" class="btn btn-default" id="crossRoad" onclick="CreateGraphicObject('single_solid_markup');">
											<img src="Images/markup_double_solid.png" alt="Road" style="padding-right: 5px;">
											Single Solid
										</button>
									</div>
								</div>
							</div>
						</div>	
						<div class="panel panel-default">
							<a class="btn btn-default" data-toggle="collapse" data-parent="#toolboxContent" href="#carGroup" style="width:100%">
								Transport
							</a>
							<div id="carGroup" class="panel-collapse collapse">
								<div class="panel-body">
									<div class="btn-group-vertical" style="width: 100%;">
										<button type="button" class="btn btn-default" id="car" onclick="CreateGraphicObject('car');">
											<img src="Images/car.png" alt="Road">
											Car
										</button>
										<button type="button" class="btn btn-default" id="red_car" onclick="CreateGraphicObject('red_car');">
											<img src="Images/red_car.png" alt="Road">
											Car
										</button>
										<button type="button" class="btn btn-default" id="orange_car" onclick="CreateGraphicObject('orange_car');">
											<img src="Images/orange_car.png" alt="Road">
											Car
										</button>
									</div>
								</div>
							</div>
						</div>	
						<div class="panel panel-default">
							<a class="btn btn-default" data-toggle="collapse" data-parent="#toolboxContent" href="#signGroup" style="width:100%">
								Signs
							</a>
							<div id="signGroup" class="panel-collapse collapse">
								<div class="panel-body">
									<div class="btn-group-vertical" style="width: 100%;">
										<button type="button" class="btn btn-default" id="mainroadsign" onclick="CreateGraphicObject('mainroadsign');">
											<img src="Images/mainRoadSign.png" alt="sign">
											Priority Sign
										</button>
										<button type="button" class="btn btn-default" id="sign_2_4" onclick="CreateGraphicObject('sign_2_4');">
											<img src="Images/sign_2_4.png" alt="sign">
											Give Way
										</button>
										<button type="button" class="btn btn-default" id="sign_3_24" onclick="CreateGraphicObject('sign_3_24');">
											<img src="Images/sign_3_24.png" alt="sign">
											Speed Limit
										</button>
									</div>
								</div>
							</div>
						</div>
						<div class="panel panel-default">
							<a class="btn btn-default" data-toggle="collapse" data-parent="#toolboxContent" href="#lightGroup" style="width:100%">
								Lights
							</a>
							<div id="lightGroup" class="panel-collapse collapse">
								<div class="panel-body">
									<div class="btn-group-vertical" style="width: 100%;">
										<button type="button" class="btn btn-default" id="simple_light" onclick="CreateGraphicObject('simple_light');">
											<img src="Images/simple_light.png" alt="light">
											Simple Light
										</button>
									</div>
								</div>
							</div>
						</div>									
					</div>	
					<div id="propertiesContent">
						<div id="propertiesList" class="container-fluid" style="height: auto;">
						</div>
					</div>
				</div>				
			</div> 
		</div>
	</body>
	<script type="text/javascript">
		var mousePos;
		$('.btn').click(function() {
			var btns = document.querySelectorAll(".btn.active");
			[].forEach.call(btns, function(bt){
				bt.classList.remove("active");
			});
		    $(this).toggleClass('active');
		});

		Array.min = function (array){
			return Math.min.apply( Math, array );
		}
		
		var initSelectableTree = function(d) {
			return $('#treeview-selectable').treeview({
				data: d,
				multiSelect: false,
				onNodeSelected: function(event, node) {
					var object = getObjectByNameRec(node.text, fCanvas);
					if (object){
						fCanvas.setActiveObject(object);
					}
				},
				onNodeUnselected: function (event, node) {
					$('#selectable-output').prepend('<p>' + node.text + ' was unselected</p>');
				}
			});
		};
		var $selectableTree = initSelectableTree([]);
			
		var fCanvas;
		window.onload = function (){			
			var oldCanvas = document.getElementById('canvas');
			fCanvas = new fabric.Canvas('canvas', 
			{ 
				width: oldCanvas.parentNode.clientWidth, 
				height: oldCanvas.parentNode.clientHeight,
				childs: []
			});
			var text = new fabric.Text('60',{
						left: 12, top: 12,
						fill: 'black',
						fontSize: 24,
						fontFamily: 'signsFont'
					});
			fCanvas.on('object:selected', function(e) {
				showProperties(e.target);
				if (e.target.hasOwnProperty('obj_class') && e.target.obj_class.indexOf('road') > -1 && e.target.isType('group')){
					fCanvas.sendToBack(e.target);		
				}
				if (e.target.hasOwnProperty('obj_class') && 
					(e.target.obj_class.indexOf('road') == -1 && e.target.obj_class != 'line')){
					fCanvas.bringToFront(e.target);
				}
			});
			fCanvas.on('mouse:move', function(options) {
				mousePos = fCanvas.getPointer(options.e);				
			});
			fCanvas.on('mouse:down', function(options) {
				if (options.target){
					var thisTarget = options.target; 
					var mousePos = fCanvas.getPointer(options.e);
					if (thisTarget.isType('group') && thisTarget.hasOwnProperty('name') 
							&& thisTarget.name.indexOf('cross_') > -1) {
						thisTarget.forEachObject(function(obj){
							var corners = obj.get('oCoords');
							// my own function (containsPoint doesn't work) 
							// bug in Fabric.js: .oCoords is not changing after rotation, 
							// so this function is not working for rotated group
							if (isPointInLocation(mousePos.x,mousePos.y, 
								[ {x: thisTarget.left + corners.tl.x, y: thisTarget.top + corners.tl.y},
								  {x: thisTarget.left + corners.tr.x, y: thisTarget.top + corners.tr.y}, 
								  {x: thisTarget.left + corners.bl.x, y: thisTarget.top + corners.bl.y},
								  {x: thisTarget.left + corners.br.x, y: thisTarget.top + corners.br.y}]))
							{
								fCanvas.setActiveObject(obj);
							}							
						});
					}
					if (thisTarget.isType('group') && thisTarget.hasOwnProperty('obj_class') 
						&& thisTarget.obj_class == 'road'){
							thisTarget.forEachObject(function(obj){
							var corners = obj.get('oCoords');
							// my own function (containsPoint doesn't work) 
							// bug in Fabric.js: .oCoords is not changing after rotation, 
							// so this function is not working for rotated group
							if (isPointInLocation(mousePos.x,mousePos.y, 
								[ {x: thisTarget.left + corners.tl.x, y: thisTarget.top + corners.tl.y},
								  {x: thisTarget.left + corners.tr.x, y: thisTarget.top + corners.tr.y}, 
								  {x: thisTarget.left + corners.bl.x, y: thisTarget.top + corners.bl.y},
								  {x: thisTarget.left + corners.br.x, y: thisTarget.top + corners.br.y}]))
							{
								fCanvas.setActiveObject(obj);
							}							
						});
					}
				}else{
					showObjects();
				}
			});
			fCanvas.on('object:moving', function(e) {
				
			});

			fCanvas.on('object:modified', function(e) {
				var activeObject = e.target;						
				if (activeObject.hasOwnProperty('name') && activeObject.name.indexOf('road') == 0){
					fCanvas.forEachObject(function(obj){				  		
						if (obj != activeObject && obj.hasOwnProperty('name') && obj.name.indexOf('road') == 0){
							var objCorners = obj.get('oCoords');
							var actCorners = activeObject.get('oCoords');						
				    		createCrossRoad(objCorners, actCorners, {aName: activeObject.name, oName: obj.name});					    		
				    	}
					});			  	
				}
				if (activeObject.hasOwnProperty('obj_class') && activeObject.obj_class != 'road'){
					var lines = getObjectsByClass('line');
					lines.forEach(function(line){
						if (activeObject != line){
							var index = line.childs.indexOf(activeObject);
							var oldParent = activeObject.parent == '' ? fCanvas : activeObject.parent;							
							if (line.containsPoint(mousePos))
							{
								if (index == -1){
									line.childs[line.childs.length] = activeObject;
									activeObject.parent = line;
									var oldParentIndex = oldParent.childs.indexOf(activeObject);
									if (oldParentIndex > -1){
										oldParent.childs.splice(index, 1);
									}
								}
							}else{								
								if (index > -1){
									line.childs.splice(index, 1);
									activeObject.parent = '';
								}
							}
						}
					});
					var test = getChildObjects(fCanvas.childs[0]);
					UpdateTreeView();
				}
			});
			fCanvas.on('object:added', function(e){
				if (!e.target.hasOwnProperty('parent')){
					e.target.parent = '';
				}
				if (!e.target.hasOwnProperty('childs')){
					e.target.childs = [];
				}
				if (e.target.parent == '' && fCanvas.childs.indexOf(e.target) == -1){
					fCanvas.childs[fCanvas.childs.length] = e.target;
				}
				UpdateTreeView();
			});
			fCanvas.on('object:removed', function(e){
				var removedObj = e.target;
				var childs = getChildObjects(removedObj);
				childs.forEach(function(child){
					fCanvas.remove(child);
				});
				var oldParent;
				if (removedObj.hasOwnProperty('parent') && removedObj.parent != ''){
					if (removedObj.parent.hasOwnProperty('name')){
						oldParent = removedObj.parent;
					}else{
						oldParent = getObjectByName(removedObj.parent);						
					}						
				}else{
					oldParent = fCanvas;
				}
				var index = oldParent.childs.indexOf(removedObj);
				if (index > -1){
					oldParent.childs.splice(index, 1);
				}
				UpdateTreeView();
				showObjects();
			});

			var canvasDiv = document.getElementById('canvasDiv');
			canvasDiv.tabIndex = 1000;
			canvasDiv.addEventListener("keydown", canvKeyDown, false);
		}
		
		window.onresize = function(){
			fCanvas.setHeight($('#canvasDiv').height()); 
			fCanvas.setWidth($('#canvasDiv').width()); 
			fCanvas.calcOffset();
			fCanvas.style="background: white;";
			fCanvas.renderAll(); 
		}

		function canvKeyDown(e){
			if (e.keyCode == 46){
				fCanvas.remove(fCanvas.getActiveObject());
			}
		}
		
		function dropElement(id){
			
		}
		
		function removeUnusedControls(object){
			object['setControlVisible']('tl', false);	
			object['setControlVisible']('bl', false);	
			object['setControlVisible']('tr', false);	
			object['setControlVisible']('br', false);	
			object['setControlVisible']('mb', false);	
			object['setControlVisible']('mt', false);	
		}

		function CreateGraphicObject(id){
			// maybe do not use graphic objects for some situation objects (f.e. lines could be a 'virtual' objects)
			if (id == 'singleRoad'){
				var w = 200; h = 50;
				var line1 = new fabric.Rect({ 
					width: w, height: h, 
					fill: 'black',
					name: 'line_' + fCanvas.getObjects().length,
					obj_class: 'line',
					obj_type: 'asphalt',
					childs: []				
				});
				//fCanvas.add(line1);
				var line2 = new fabric.Rect({ 
					left: 0, top: h, 
					width: w, height: h, 
					fill: 'black',
					name: 'line_' + (fCanvas.getObjects().length+1),
					obj_class: 'line',
					obj_type: 'asphalt',
					childs: []						
				});
				//fCanvas.add(line2);
				/*var mark = new fabric.Line([0, h/2-1, w, h/2-1], { 
					stroke:'white', 
					strokeWidth: 3, 
					strokeDashArray: [20, 5], 
					name: 'markup_' + (fCanvas.getObjects().length),
					obj_class: 'markup',
					obj_type: 'separate',
					childs: [],
					lockScalingY: true
				});		
				removeUnusedControls(mark);*/				
				var road = new fabric.Rect({ 
					width: w, height: h*2 
										
				});
				// using child-parent concept,  
				var roadGroup = new fabric.Group([line1,line2,road],
				{ 
					left: 0, top: 0, 
					name: 'road_' + (fCanvas.getObjects().length),
					obj_class: 'road',
					obj_type: 'asphalt',
					lines: 2,
					childs: [line1,line2],//,mark],
					parent: "",
					lockScalingY: true	 
				});
				roadGroup.updateLinesNumber = function(number){
					
				};
				removeUnusedControls(roadGroup);
				//mark.parent = 
				line2.parent = line1.parent = roadGroup;
				//fCanvas.add(mark);
				fCanvas.childs[fCanvas.childs.length] = roadGroup;
				fCanvas.add(roadGroup);
				fCanvas.sendToBack(roadGroup);				
			}
			if (id.indexOf('car') > -1){
				var url;
				if (id == 'car') { url = 'Images/car_above_view.png'; }
				if (id == 'red_car') { url = 'Images/red_car_above_view.png'; } 
				if (id == 'orange_car') { url = 'Images/orange_car_above_view.png'; }  
				fabric.Image.fromURL(url, function(img) {
					var carImg = img.set({ 
						left: 0, top: 0
					});
					var lforward = new fabric.Circle({
						left: carImg.left + carImg.width - 10, top: carImg.top, 
						radius: 5,
						fill: 'yellow',
						visible: false
					});
					
					var lback = new fabric.Circle({
						left: carImg.left, top: carImg.top, 
						radius: 5,
						fill: 'yellow',
						visible: false
					});
					var rforward = new fabric.Circle({
						left: carImg.left + carImg.width - 10, top: carImg.top + carImg.height - 10, 
						radius: 5,
						fill: 'yellow',
						visible: false
					});
					
					var rback = new fabric.Circle({
						left: carImg.left, top: carImg.top + carImg.height - 10, 
						radius: 5,
						fill: 'yellow',
						visible: false
					});
					var carGroup = new fabric.Group([carImg, lforward, lback, rforward, rback], {
						left: 0, top: 0, 
						name: 'car_' + fCanvas.getObjects().length,
						obj_class: 'car',
						obj_type: 'simple',
						childs: [],
						parent: "",
						lockScalingY: true,
						lockScalingX: true
					})
					carGroup.updateDirIndicators = function(left, right){
						if (left != 'do not update'){
							if (left == true || left == 'true' || left == 'yes' || left == '+' || left == '1'){
								this.getObjects()[1].visible = true;
								this.getObjects()[2].visible = true;
							}else{
								this.getObjects()[1].visible = false;
								this.getObjects()[2].visible = false;
							}
						}
						if (right != 'do not update'){
							if (right == true || right == 'true' || right == 'yes' || right == '+' || right == '1'){
								this.getObjects()[3].visible = true;
								this.getObjects()[4].visible = true;
							}else{
								this.getObjects()[3].visible = false;
								this.getObjects()[4].visible = false;
							}
						}
						fCanvas.renderAll();
					}
					removeUnusedControls(carGroup);
					carImg['setControlVisible']('ml', false);
					carImg['setControlVisible']('mr', false);
					fCanvas.childs[fCanvas.childs.length] = carGroup;
					fCanvas.add(carGroup);
				});
			}
			if (id == 'single_dotted_markup'){
				var w = 200; h = 100;
				var mark = new fabric.Line([0, h/2-1, w, h/2-1], { 
					stroke:'white', 
					strokeWidth: 3, 
					strokeDashArray: [20, 5], 
					name: 'markup_' + (fCanvas.getObjects().length),
					obj_class: 'markup',
					obj_type: 'separate',
					childs: [],
					parent: '',
					lockScalingY: true
				});				
				removeUnusedControls(mark);
				fCanvas.childs[fCanvas.childs.length] = mark;
				fCanvas.add(mark);				
			}
			if (id == 'mainroadsign'){
				fabric.Image.fromURL('Images/mainRoadSign.png', function(img) {
					var image = img.set({ 
						left: 0, top: 0, 
						name: 'sign_2.1_' + fCanvas.getObjects().length,
						obj_class: 'sign',
						obj_type: 'priority',
						childs: [],
						parent: "",
						number: '2.1',
						lockScalingY: true,
						lockScalingX: true  
					});
					removeUnusedControls(image);
					image['setControlVisible']('ml', false);
					image['setControlVisible']('mr', false);
					fCanvas.childs[fCanvas.childs.length] = image;
					fCanvas.add(image).renderAll;
				});
			}
			if (id == 'sign_2_4'){
				fabric.Image.fromURL('Images/sign_2_4.png', function(img) {
					var image = img.set({ 
						left: 0, top: 0, 
						name: 'sign_2.4_' + fCanvas.getObjects().length,
						obj_class: 'sign',
						obj_type: 'priority',
						childs: [],
						parent: "",
						number: '2.4',
						lockScalingY: true,
						lockScalingX: true  
					});
					removeUnusedControls(image);
					image['setControlVisible']('ml', false);
					image['setControlVisible']('mr', false);
					fCanvas.childs[fCanvas.childs.length] = image;
					fCanvas.add(image).renderAll;
				});
			}
			if (id == 'sign_3_24'){
				fabric.Image.fromURL('Images/sign_3_24_template.png', function(img) {
					var image = img.set({ 
						left: 0, top: 0						 
					});
					var text = new fabric.Text('60',{
						left: 12, top: 12,
						fill: 'black',
						fontSize: 24,
						fontFamily: 'signsFont'
					});
					var signGroup = new fabric.Group([image, text],{
						left: 0, top: 0,
						name: 'sign_3.24_' + fCanvas.getObjects().length,
						obj_class: 'sign',
						obj_type: 'prohibiting',
						childs: [],
						parent: "",
						number: '3.24',
						limit: '60',
						lockScalingY: true,
						lockScalingX: true 
					});
					removeUnusedControls(signGroup);
					signGroup.updateText = function (newText){
						var txtObj = this.getObjects()[1];
						if (newText.length == 3){
							txtObj.left = 10 - this.width/2;
						}
						if (newText.length == 2){
							txtObj.left = 12 - this.width/2;
						}
						if (newText.length == 1){
							txtObj.left = 20 - this.width/2;
						}
						txtObj.text = newText;
						fCanvas.renderAll();
					};
					signGroup['setControlVisible']('ml', false);
					signGroup['setControlVisible']('mr', false);
					fCanvas.childs[fCanvas.childs.length] = signGroup;
					fCanvas.add(signGroup);
				});
			}
			
			if (id.indexOf('light') > -1){
				var body = new fabric.Rect({ width: 20, height: 65, rx: 5, ry: 5 });
				var red = new fabric.Circle({
					left: body.left + 2, top: body.top + 5, 
					radius: 8,
					fill: 'gray'
				});
				var yellow = new fabric.Circle({
					left: body.left + 2, top: body.top + 25, 
					radius: 8,
					fill: 'gray'
				});
				var green = new fabric.Circle({
					left: body.left + 2, top: body.top + 45, 
					radius: 8,
					fill: 'gray'
				});
				var lightGroup = new fabric.Group([body, red, yellow, green], {
					left: 0, top: 0,
					name: 'light_' + fCanvas.getObjects().length,
					obj_class: 'light',
					obj_type: 'simple',
					childs: [],
					parent: "",
					signal: '',
					lockScalingY: true,
					lockScalingX: true
				});
				lightGroup.updateSignal = function (signal){
					if (signal == 'red' || signal == 'r'){
						lightGroup.getObjects()[1].fill = 'red';
						lightGroup.getObjects()[2].fill = 'gray';
						lightGroup.getObjects()[3].fill = 'gray';
					}
					if (signal == 'yellow' || signal == 'y'){
						lightGroup.getObjects()[1].fill = 'gray';
						lightGroup.getObjects()[2].fill = 'yellow';
						lightGroup.getObjects()[3].fill = 'gray';
					}
					if (signal == 'green' || signal == 'g'){
						lightGroup.getObjects()[1].fill = 'gray';
						lightGroup.getObjects()[2].fill = 'gray';
						lightGroup.getObjects()[3].fill = 'green';
					}
					fCanvas.renderAll();
				}
				removeUnusedControls(lightGroup);
				lightGroup['setControlVisible']('ml', false);
				lightGroup['setControlVisible']('mr', false);
				fCanvas.childs[fCanvas.childs.length] = lightGroup;
				fCanvas.add(lightGroup);
			}
			fCanvas.renderAll();
		}
		
		function getChildObjects(object){
			result = [];
			return getChildObjectsRec(object, result);
		}
		
		function getChildObjectsRec(object, result){
			if (object.hasOwnProperty('childs')){
				result[result.length] = object;
				for (var i = 0; i < object.childs.length; i++){
					getChildObjectsRec(object.childs[i], result);
				}
			}
			return result;
		}
		
		function UpdateTreeView(){
			var childs = fCanvas.childs;
			var data = [];  
			for (var i = 0; i < childs.length; i++){
				if (childs[i].hasOwnProperty('obj_class')) {
					data[data.length] = getNodesFromObject(childs[i]);
				}
			}
			$selectableTree = initSelectableTree(data);
		}
		
		function getNodesFromObject(object){
			if (object.hasOwnProperty('childs') && object.childs.length > 0){
				var result = [];
				object.childs.forEach(function(child){
					var node = getNodesFromObject(child);
					if (node){
						result[result.length] = node;
					}
				});				
				if (result.length > 0){
					return { text: object.name, href: '#' + object.name, nodes: result };
				}else{
					return { text: object.name, href: '#' + object.name };
				}
			}else{
				if (object.hasOwnProperty('name')){
					return { text: object.name, href: '#' + object.name, tags: ['0'] };
				}else{
					return false;
				}				
			}
			return false;
		}

		function loadPattern(url, element) {
			fabric.util.loadImage(url, function(img) {
				element.setPatternFill({
					source: img
				});
				fCanvas.renderAll();
			});
		}

  		function createCrossRoad(objCorners, actCorners, names){
  			var actPrepared = prepareIntersection({start: {x: actCorners.tl.x, y: actCorners.tl.y}, end: {x: actCorners.tr.x, y: actCorners.tr.y}}, {start: {x: actCorners.bl.x, y: actCorners.bl.y}, end: {x: actCorners.br.x, y: actCorners.br.y}});
    		var objPrepared = prepareIntersection({start: {x: objCorners.tl.x, y: objCorners.tl.y}, end: {x: objCorners.tr.x, y: objCorners.tr.y}}, {start: {x: objCorners.bl.x, y: objCorners.bl.y}, end: {x: objCorners.br.x, y: objCorners.br.y}});
    		
    		var corner1 = getCornerPoints(actPrepared.topLine.start, actPrepared.topLine.end, objPrepared.topLine.start, objPrepared.topLine.end, 'aToT');
    		var corner2 = getCornerPoints(actPrepared.topLine.start, actPrepared.topLine.end, objPrepared.bottomLine.start, objPrepared.bottomLine.end, 'aToB');
    		var corner3 = getCornerPoints(actPrepared.bottomLine.start, actPrepared.bottomLine.end, objPrepared.topLine.start, objPrepared.topLine.end, 'aBoT');
    		var corner4 = getCornerPoints(actPrepared.bottomLine.start, actPrepared.bottomLine.end, objPrepared.bottomLine.start, objPrepared.bottomLine.end, 'aBoB');

    		var minX = fCanvas.width, minY = fCanvas.height;
    		var path ='';
    		if (corner1){
    			path += 'M ' + corner1.p1.x + ' ' + corner1.p1.y + ' Q ' + corner1.p2.x + ' ' + corner1.p2.y + ' ' + corner1.p3.x + ' ' + corner1.p3.y + ' ';
    			minX = Math.min(corner1.p1.x,corner1.p2.x,corner1.p3.x, minX);
    			minY = Math.min(corner1.p1.y,corner1.p2.y,corner1.p3.y, minY);
    		}
    		if (corner3){
				var c;
				if (path.indexOf('M ') < 0){
					c = 'M ';
				}else{
					c = ' L ';
				}
    			path += c + corner3.p3.x + ' ' + corner3.p3.y + ' Q ' + corner3.p2.x + ' ' + corner3.p2.y + ' ' + corner3.p1.x + ' ' + corner3.p1.y + ' ';

    			minX = Math.min(corner3.p1.x,corner3.p2.x,corner3.p3.x, minX);
    			minY = Math.min(corner3.p1.y,corner3.p2.y,corner3.p3.y, minY);
    		}						
    		if (corner4){
				var c;
				if (path.indexOf('M ') < 0){
					c = 'M ';
				}else{
					c = ' L ';
				}    			
    			path += c + corner4.p1.x + ' ' + corner4.p1.y + ' Q ' + corner4.p2.x + ' ' + corner4.p2.y + ' ' + corner4.p3.x + ' ' + corner4.p3.y + ' ';

    			minX = Math.min(corner4.p1.x,corner4.p2.x,corner4.p3.x, minX);
    			minY = Math.min(corner4.p1.y,corner4.p2.y,corner4.p3.y, minY);
    		}	
    		if (corner2){
				var c;
				if (path.indexOf('M ') < 0){
					c = 'M ';
				}else{
					c = ' L ';
				}
    			path += c + corner2.p3.x + ' ' + corner2.p3.y + ' Q ' + corner2.p2.x + ' ' + corner2.p2.y + ' ' + corner2.p1.x + ' ' + corner2.p1.y;

    			minX = Math.min(corner2.p1.x,corner2.p2.x,corner2.p3.x, minX);
    			minY = Math.min(corner2.p1.y,corner2.p2.y,corner2.p3.y, minY);
    		}

    		if (path == '' || path.indexOf('L ') < 0 || (path.match(/L /g) || []).length == 2) { return; }
			
			var tCross = false;
			if ((path.match(/L /g) || []).length == 1){
				tCross = true;
				if (corner1 && corner3){
					var corner2 //interaToB 
						= {p4: intersection3([ actPrepared.topLine.start, actPrepared.topLine.end], 
						[objPrepared.bottomLine.start, objPrepared.bottomLine.end])};
					var corner4 //interaBoB 
						= {p4: intersection3([ actPrepared.bottomLine.start, actPrepared.bottomLine.end], 
						[objPrepared.bottomLine.start, objPrepared.bottomLine.end])};
					path += ' L ' + corner4.p4.x + ' ' + corner4.p4.y + ' L ' + corner2.p4.x + ' ' + corner2.p4.y;
					minX = Math.min(minX, corner2.p4.x, corner4.p4.x);
					minY = Math.min(minY, corner2.p4.y, corner4.p4.y);
				}else{
					if (corner2 && corner4){
						var corner3 //interaBoT
							= {p4: intersection3([ actPrepared.bottomLine.start, actPrepared.bottomLine.end], 
							[objPrepared.topLine.start, objPrepared.topLine.end])};
						var corner1 //interaToT
							= {p4: intersection3([ actPrepared.topLine.start, actPrepared.topLine.end], 
							[objPrepared.topLine.start, objPrepared.topLine.end])};
						path += ' L ' + corner1.p4.x + ' ' + corner1.p4.y + ' L ' + corner3.p4.x + ' ' + corner3.p4.y;
						minX = Math.min(minX, corner1.p4.x, corner3.p4.x);
						minY = Math.min(minY, corner1.p4.y, corner3.p4.y);
					}else{
						if (corner1 && corner2){
							var corner3 //interaBoT
								= {p4: intersection3([ actPrepared.bottomLine.start, actPrepared.bottomLine.end], 
								[objPrepared.topLine.start, objPrepared.topLine.end])};
							var corner4 //interaBoB
								= {p4: intersection3([ actPrepared.bottomLine.start, actPrepared.bottomLine.end], 
								[objPrepared.bottomLine.start, objPrepared.bottomLine.end])};
							var pathParts = path.split('L');
							path = pathParts[0] + ' L ' + corner3.p4.x + ' ' + corner3.p4.y + ' L ' + corner4.p4.x + ' ' + corner4.p4.y + ' ' + pathParts[1];
							minX = Math.min(minX, corner3.p4.x, corner4.p4.x);
							minY = Math.min(minY, corner3.p4.y, corner4.p4.y);
						}else{
							if (corner3 && corner4){
								var corner1 //interaToT
									= {p4: intersection3([ actPrepared.topLine.start, actPrepared.topLine.end], 
									[objPrepared.topLine.start, objPrepared.topLine.end])};
								var corner2 //interaToB
									= {p4: intersection3([ actPrepared.topLine.start, actPrepared.topLine.end], 
									[objPrepared.bottomLine.start, objPrepared.bottomLine.end])};
								path += ' L ' + corner2.p4.x + ' ' + corner2.p4.y + ' L ' + corner1.p4.x + ' ' + corner1.p4.y;
								minX = Math.min(minX, corner1.p4.x, corner2.p4.x);
								minY = Math.min(minY, corner1.p4.y, corner2.p4.y);
							}
						}
					}
				}
			}
    		var minPoint = 
    		{
    			x: minX,
    			y: minY
    		}    		

    		var crossRoad = new fabric.Path(path, {
  					left: minPoint.x,
  					top: minPoint.y,
  					fill: 'black',
					name: 'cross_' + names.aName + '_' + names.oName,
					perPixelTargetFind: true,
					obj_class: 'cross_road',
					obj_type: 'asphalt',
					childs: []  //,
					//hasControls: false,
					//hasBorders: false
  				});
    		var crossObjects = [];
    		//fCanvas.add(crossRoad);
			crossObjects[0] = crossRoad;
			var partName = 'road';
			// aToT aBoT
			if (corner1.hasOwnProperty('p1') || corner3.hasOwnProperty('p1')){
				var dirPoint;
				dirPoint1 = {x: actPrepared.bottomLine.end.x, y: actPrepared.bottomLine.end.y};
				dirPoint2 = {x: actPrepared.topLine.end.x, y: actPrepared.topLine.end.y};
				var actRoadPartStr1 = 'M ' + corner1.p4.x + ' ' + corner1.p4.y +
					' L ' + corner3.p4.x + ' ' + corner3.p4.y +
					' L ' + dirPoint1.x + ' ' + dirPoint1.y +
					' L ' + dirPoint2.x + ' ' + dirPoint2.y;
				var actRoadPartObj1 = new fabric.Path(actRoadPartStr1, {
						left: Math.min(corner1.p4.x, corner3.p4.x, dirPoint1.x, dirPoint2.x),
						top: Math.min(corner1.p4.y, corner3.p4.y, dirPoint1.y, dirPoint2.y),
						fill: 'black',
						name: partName + '_actRoadPartObj1',
						perPixelTargetFind: true,
						obj_class: 'road',
						obj_type: 'asphalt',
						childs: [] //,
						//hasControls: false,
						//hasBorders: false
					});
				crossObjects[crossObjects.length] = actRoadPartObj1;
				//fCanvas.add(actRoadPartObj1);
			}
			// aToB aBoB
			if (corner2.hasOwnProperty('p1') || corner4.hasOwnProperty('p1')){
				var dirPoint;
				dirPoint1 = {x: actPrepared.bottomLine.start.x, y: actPrepared.bottomLine.start.y};
				dirPoint2 = {x: actPrepared.topLine.start.x, y: actPrepared.topLine.start.y};
				var actRoadPartStr2 = 'M ' + corner2.p4.x + ' ' + corner2.p4.y +
					' L ' + corner4.p4.x + ' ' + corner4.p4.y +
					' L ' + dirPoint1.x + ' ' + dirPoint1.y +
					' L ' + dirPoint2.x + ' ' + dirPoint2.y;
				var actRoadPartObj2 = new fabric.Path(actRoadPartStr2, {
						left: Math.min(corner2.p4.x, corner4.p4.x,  dirPoint1.x, dirPoint2.x),
						top: Math.min(corner2.p4.y, corner4.p4.y, dirPoint1.y, dirPoint2.y),
						fill: 'black',
						name: partName + '_actRoadPartObj2',
						perPixelTargetFind: true,
						obj_class: 'road',
						obj_type: 'asphalt',
						childs: [] //,
						//hasControls: false,
						//hasBorders: false
					});
				//fCanvas.add(actRoadPartObj2);
				crossObjects[crossObjects.length] = actRoadPartObj2;
			}
			// aToT aToB
			if (corner1.hasOwnProperty('p1') || corner2.hasOwnProperty('p1')){
				var dirPoint;
				dirPoint1 = {x: objPrepared.bottomLine.end.x, y: objPrepared.bottomLine.end.y};
				dirPoint2 = {x: objPrepared.topLine.end.x, y: objPrepared.topLine.end.y};
				var actRoadPartStr3 = 'M ' + corner1.p4.x + ' ' + corner1.p4.y +
					' L ' + corner2.p4.x + ' ' + corner2.p4.y +
					' L ' + dirPoint1.x + ' ' + dirPoint1.y +
					' L ' + dirPoint2.x + ' ' + dirPoint2.y;
				var actRoadPartObj3 = new fabric.Path(actRoadPartStr3, {
						left: Math.min(corner1.p4.x, corner2.p4.x, dirPoint1.x, dirPoint2.x),
						top: Math.min(corner1.p4.y, corner2.p4.y, dirPoint1.y, dirPoint2.y),
						fill: 'black',
						name: partName + '_actRoadPartObj3',
						perPixelTargetFind: true,
						obj_class: 'road',
						obj_type: 'asphalt',
						childs: [] //,
						//hasControls: false,
						//hasBorders: false
					});
				//fCanvas.add(actRoadPartObj3);
				crossObjects[crossObjects.length] = actRoadPartObj3;
			}
			// aBoT aBoB
			if (corner3.hasOwnProperty('p1') || corner4.hasOwnProperty('p1')){
				var dirPoint;
				dirPoint1 = {x: objPrepared.bottomLine.start.x, y: objPrepared.bottomLine.start.y};
				dirPoint2 = {x: objPrepared.topLine.start.x, y: objPrepared.topLine.start.y};
				var actRoadPartStr4 = 'M ' + corner3.p4.x + ' ' + corner3.p4.y +
					' L ' + corner4.p4.x + ' ' + corner4.p4.y +
					' L ' + dirPoint1.x + ' ' + dirPoint1.y +
					' L ' + dirPoint2.x + ' ' + dirPoint2.y;
				var actRoadPartObj4 = new fabric.Path(actRoadPartStr4, {
						left: Math.min(corner3.p4.x, corner4.p4.x, dirPoint1.x, dirPoint2.x),
						top: Math.min(corner3.p4.y, corner4.p4.y, dirPoint1.y, dirPoint2.y),
						fill: 'black',
						name: partName + '_actRoadPartObj4',
						perPixelTargetFind: true,
						obj_class: 'road',
						obj_type: 'asphalt',
						childs: [] //,
						//hasControls: false,
						//hasBorders: false
					});
				//fCanvas.add(actRoadPartObj4);
				crossObjects[crossObjects.length] = actRoadPartObj4;
			}
			removeObjectByName(names.aName); removeObjectByName(names.oName);			
			var roadGroup = new fabric.Group(crossObjects, 
				{
					name: 'cross_' + fCanvas.getObjects().length,
					originX: 'center',
    				originY: 'center',
					perPixelTargetFind: true,
					obj_class: 'cross_road',
					obj_type: 'asphalt',
					childs: crossObjects,
					parent: ''
					//hasControls: false,
					//hasBorders: false
				});			
			crossObjects.forEach(function(obj){
				obj.parent = roadGroup;
			});
			fCanvas.add(roadGroup);
  		}

  		function removeObjectByName(name){
  			fCanvas.forEachObject(function(obj){
  				if (obj.name == name) 
  				{ 
  					fCanvas.remove(obj); 
  				}
  			});
  		}
		  
		function getObjectByName(name){
			return getObjectByNameRec(name, fCanvas);
		}
		
		function getObjectByNameRec(name, area){
			if (area.hasOwnProperty('name') && area.name == name){
				return area;
			}
			if (area.hasOwnProperty('_objects') && area._objects.length > 0){
				var result = false;
				var i = 0;
				while (!result && i < area._objects.length){
					result = getObjectByNameRec(name,area._objects[i++]);
				}
				return result;
			}
			return false;
		}
		
		function getObjectsByClass(c){
			var result = [];
			return getObjectsByClassRec(c, fCanvas, result);
		}
		
		function getObjectsByClassRec(c, area, result){
			if (area.hasOwnProperty('obj_class') && area.obj_class == c){
				result[result.length] = area;
			}else{
				if (area.hasOwnProperty('_objects') && area._objects.length > 0){
					for (var i = 0; i < area._objects.length; i++){
						getObjectsByClassRec(c,area._objects[i], result);
					}
				}
			}
			return result;
		}

		// array []
  		function removeObjectByNameParts(parts){
  			fCanvas.forEachObject(function(obj){
				var del = false;
				for (var i = 0; i < parts.length; i++){
					if (obj.name.indexOf(parts[i]) > -1){
						del = true;
					}
					else{
						del = false;
						break;
					}
				}
  				if (del) 
  				{ 
  					fCanvas.remove(obj); 
  				}
  			});
  		}

  		function showObjects(){
  			document.getElementById('propertiesContent').style.display = "none";
  			document.getElementById('toolboxContent').style.display = "block";	
  		}

  		function showProperties(object){
			if (!object.hasOwnProperty('name')) { return; }
  			document.getElementById('toolboxContent').style.display = "none";
  			document.getElementById('propertiesContent').style.display = "block";
			// clear properties
			var myNode = document.getElementById('propertiesList');
			while (myNode.firstChild) {
				myNode.removeChild(myNode.firstChild);
			}
			
			if (object){								
				addProperty({name:"parent",text:"parent"}, object.parent , "cmb", getChildObjects(fCanvas));	
				initCmb();			
				var properties = sharedProperties.slice();
				if (object.hasOwnProperty('obj_class')){
					if (object.obj_class == 'road' || object.obj_class == 'cross_road'){
						Array.prototype.push.apply(properties, roadProperties);
					}
					if(object.obj_class == 'line'){
						Array.prototype.push.apply(properties, lineProperties);
					}
					if (object.obj_class == 'car'){
						Array.prototype.push.apply(properties, carProperties);
					}
					if (object.obj_class == 'sign'){
						Array.prototype.push.apply(properties, signProperties);
					}
					if (object.obj_class == 'light'){
						Array.prototype.push.apply(properties, lightProperties);
					}
					for(var i = 0; i < properties.length; i++){
						var val = '';
						if (object.hasOwnProperty(properties[i].name)){
							val = object[properties[i].name];
						}
						addProperty(properties[i], val, "input", []);
					}
				}
			}
  		}
		
		function getAllObjects(){
			result = [];
			fCanvas.forEachObject(function(o){
				Array.prototype.push.apply(result, getAllObjectsRec(o, []));
			});
			return result;
		}
		
		function getAllObjectsRec(area, result){
			if (!area.hasOwnProperty('_objects') ||
				area.hasOwnProperty('_objects') && area._objects.length == 0)
			{
				result[result.length] = area;
			}else{
				if (area.hasOwnProperty('_objects') && area._objects.length > 0){
					for (var i = 0; i < area._objects.length; i++){
						getAllObjectsRec(area._objects[i], result);
					}
				}
			}
			return result;
		}
		
		function addProperty(prop, val, type, list){
			var txtEl = document.createElement("p");
			txtEl.style="padding: 7px; margin-right: 5px;";
			var txtNode = document.createTextNode(prop.text);
			txtEl.appendChild(txtNode);		
			
			var col4 = document.createElement('div');
			col4.className = "col-sm-4";
			col4.appendChild(txtEl);
			
			var inpEl;
			if (type == "input"){
				inpEl = document.createElement("input");
				inpEl.id = prop.name + "_input";
				inpEl.type="text";
				inpEl.className="form-control";
				inpEl.value = val;
				inpEl.onchange = function (){
					fCanvas.getActiveObject()[prop.name] = inpEl.value;
					if (inpEl.id == 'name_input'){
						UpdateTreeView();
					}	
					if (inpEl.id == 'limit_input'){
						fCanvas.getActiveObject().updateText(inpEl.value);
					}
					if (inpEl.id == 'ld_indicator_input'){
						fCanvas.getActiveObject().updateDirIndicators(inpEl.value, 'do not update')
					}			
					if (inpEl.id == 'rd_indicator_input'){
						fCanvas.getActiveObject().updateDirIndicators('do not update', inpEl.value)
					}
					if (inpEl.id == 'signal_input'){
						fCanvas.getActiveObject().updateSignal(inpEl.value)
					}
				};
			}
			if (type == "cmb"){
				inpEl = document.createElement("select");
				inpEl.id = prop.name + "_cmb";
				inpEl.className="js-example-basic-single js-states form-control select2-hidden-accessible";
				inpEl.onchange = function (){
					var activeObj = fCanvas.getActiveObject();
					var oldParent;
					if (this.oldvalue != "empty"){
						oldParent = getObjectByName(this.oldvalue);						
					}else{
						oldParent = fCanvas;
					}
					var index = oldParent.childs.indexOf(activeObj);
					if (index > -1){
						oldParent.childs.splice(index, 1);
					}
					var newParent;
					if (this.value != "empty"){
						newParent = getObjectByName(inpEl.value);
					}else{
						newParent = fCanvas;
					}
					activeObj[prop.name] = newParent;	
					if (!newParent.hasOwnProperty('childs')){
						newParent.childs = [];
					}				
					newParent.childs[newParent.childs.length] = activeObj;
					this.oldvalue = this.value;						
					UpdateTreeView();
				};
				inpEl.onfocus = function(){
					this.oldvalue = this.value;	
				};
				var option = document.createElement("option");
				option.value = "empty";
				var txt = document.createTextNode("");
				option.appendChild(txt);
				inpEl.appendChild(option);
				list.forEach(function(o){
					if (o.hasOwnProperty('name')){
						var option = document.createElement("option");
						option.value = o.name;
						var txt = document.createTextNode(o.name);
						option.appendChild(txt);
						inpEl.appendChild(option);
					}
				});
				if (val.hasOwnProperty('name')){
					inpEl.value = val.name;
				}else{
					inpEl.value = "empty";
				}
			}
			
			var col8 = document.createElement('div');
			col8.className = "col-sm-8";
			col8.appendChild(inpEl);
			
			var divRow = document.createElement('div');
			divRow.className = "row";			
			divRow.appendChild(col4);			
			divRow.appendChild(col8);
			
			var propList = document.getElementById("propertiesList");
			propList.appendChild(divRow);
		}
		
		function initCmb(){
			// attention! select2.bootstrap.min was modified! removed absolute position and width set to 100%
			$(".js-example-basic-single js-states form-control select2-hidden-accessible").select2();
		}
		
		function doExport(){
			var propToExport = createJsonProperties();
			var exportData = window._json = fCanvas.toJSON(propToExport);
			fCanvas.includeDefaultValues = false;
			exportData = JSON.stringify(exportData);
			var stamp = new Date().getTime();
			download(stamp+'_road_situation.json', exportData);
		}
		
		function download(filename, text) {
			var element = document.createElement('a');
			element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
			element.setAttribute('download', filename);

			element.style.display = 'none';
			document.body.appendChild(element);

			element.click();

			document.body.removeChild(element);
		}		
	</script>
</html>
